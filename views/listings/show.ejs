<% layout('layouts/boilerplate') %>
<link rel="stylesheet" href="/css/show.css">

    <div class="listing-show-container">
        <h2 class="listing-show-title">
            <%= post.title %>
        </h2>
        
        <div class="listing-show-card">
            <img src="<%= post.image.url %>" class="listing-show-image" alt="<%= post.title %>">
            
            <div class="listing-show-body">
                <div class="listing-badges">
                    <span class="badge-custom badge-category">
                        <i class="fa-solid fa-tag"></i>
                        <%= post.category %>
                    </span>
                    <span class="badge-custom badge-owner">
                        <i class="fa-solid fa-user"></i>
                        <%= post.owner ? post.owner.username : 'Unknown' %>
                    </span>
                    <span class="badge-custom badge-location">
                        <i class="fa-solid fa-location-dot"></i>
                        <%= post.location %>, <%= post.country %>
                        <img src="https://flagcdn.com/24x18/<%= (post.country || '').toLowerCase().replace(/ /g, '-') %>.png"
                            alt="<%= post.country %> flag"
                            onerror="this.style.display='none'">
                    </span>
                </div>

                <div class="listing-price-section">
                    <div class="listing-price-main">
                        &#8377;<%= post.price.toLocaleString("en-IN") %>
                        <span class="listing-price-badge">per night</span>
                    </div>
                    <div class="tax-info">
                        <span class="tax-amount" style="display:block;"></span>
                    </div>
                </div>

                        <p class="listing-description">
                            <%= post.description %>
                        </p>

                        <div class="features-section">
                            <span class="feature-badge"><i class="fa-solid fa-bed"></i> Roomy</span>
                            <span class="feature-badge"><i class="fa-solid fa-wifi"></i> Free WiFi</span>
                            <span class="feature-badge"><i class="fa-solid fa-mug-hot"></i> Breakfast</span>
                            <span class="feature-badge"><i class="fa-solid fa-tree"></i> Nature View</span>
                        </div>

                        <% if (post.features && post.features.length) { %>
                            <div class="features-section">
                                <% post.features.forEach(function(feature) { %>
                                    <span class="feature-badge">
                                        <i class="fa-solid fa-circle-check feature-check"></i>
                                        <%= feature %>
                                    </span>
                                <% }) %>
                            </div>
                        <% } %>
                        
                        <% if (post.cityTags && post.cityTags.length) { %>
                            <div class="features-section">
                                <% post.cityTags.forEach(function(tag) { %>
                                    <span class="badge-custom" style="background: #dbeafe; color: #1e40af;">
                                        <i class="fa-solid fa-city"></i>
                                        <%= tag %>
                                    </span>
                                <% }) %>
                            </div>
                        <% } %>

                        <!-- Date Selection - Modern Style -->
                        <div class="date-selection-section">
                            <h4 class="date-section-title">
                                <i class="fa-regular fa-calendar"></i>
                                Select Your Dates
                            </h4>
                            <div class="date-picker-grid">
                                <div class="date-input-group">
                                    <label class="date-label">Check-in</label>
                                    <input type="date" id="checkInDate" class="date-input" placeholder="Select date">
                                </div>
                                <div class="date-input-group">
                                    <label class="date-label">Check-out</label>
                                    <input type="date" id="checkOutDate" class="date-input" placeholder="Select date">
                                </div>
                            </div>
                            <div class="booking-summary" id="bookingSummary" style="display: none;">
                                <div class="summary-row">
                                    <span class="summary-label">Total nights:</span>
                                    <span class="summary-value" id="totalNights">0</span>
                                </div>
                                <div class="summary-row">
                                    <span class="summary-label">Price per night:</span>
                                    <span class="summary-value">₹<%= post.price.toLocaleString("en-IN") %></span>
                                </div>
                                <div class="summary-row summary-total">
                                    <span class="summary-label">Total price:</span>
                                    <span class="summary-value" id="totalPrice">₹0</span>
                                </div>
                                <button class="btn-book" type="button">
                                    <i class="fa-solid fa-check"></i>
                                    Book Now
                                </button>
                            </div>
                        </div>

                        <script>
                            const checkIn = document.getElementById('checkInDate');
                            const checkOut = document.getElementById('checkOutDate');
                            const summary = document.getElementById('bookingSummary');
                            const totalNights = document.getElementById('totalNights');
                            const totalPrice = document.getElementById('totalPrice');
                            const pricePerNight = <%= post.price %>;

                            // Set minimum date to today
                            const today = new Date().toISOString().split('T')[0];
                            checkIn.setAttribute('min', today);
                            checkOut.setAttribute('min', today);

                            function calculateBooking() {
                                if (checkIn.value && checkOut.value) {
                                    const start = new Date(checkIn.value);
                                    const end = new Date(checkOut.value);
                                    const nights = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
                                    
                                    if (nights > 0) {
                                        totalNights.textContent = nights;
                                        totalPrice.textContent = '₹' + (nights * pricePerNight).toLocaleString('en-IN');
                                        summary.style.display = 'block';
                                    } else {
                                        summary.style.display = 'none';
                                    }
                                } else {
                                    summary.style.display = 'none';
                                }
                            }

                            checkIn.addEventListener('change', function() {
                                checkOut.setAttribute('min', this.value);
                                calculateBooking();
                            });

                            checkOut.addEventListener('change', calculateBooking);
                        </script>

                        <% if (currUser && post.owner && currUser._id.equals(post.owner._id)) { %>
                            <div class="listing-actions">
                                <form method="get" action="/listings/<%= post.id %>/edit" style="flex: 1;">
                                    <button class="btn-edit" style="width: 100%;">
                                        <i class="fa-solid fa-edit"></i>
                                        Edit Listing
                                    </button>
                                </form>
                                <form method="POST" action="/listings/<%= post.id %>?_method=DELETE" style="flex: 1;">
                                    <button class="btn-delete" style="width: 100%;">
                                        <i class="fa-solid fa-trash"></i>
                                        Delete Listing
                                    </button>
                                </form>
                            </div>
                        <% } %>
                    </div>
                </div>
        <!-- Reviews Section -->
        <div class="reviews-section">
            <h3 class="reviews-header">Reviews</h3>
            
            <% if (currUser) { %>
                <div class="listing-show-card" style="margin-bottom: 2rem;">
                    <div class="listing-show-body">
                        <h4 style="font-size: 1.125rem; font-weight: 600; color: #18181b; margin-bottom: 1.25rem;">Leave a Review</h4>
                        <form method="post" action="/listings/<%= post.id %>/reviews" novalidate class="needs-validation">
                            <div class="mb-3">
                                <label for="rating" class="calendar-label">Rating</label>
                                <fieldset class="starability-slot">
                                    <input type="radio" id="no-rate" class="input-no-rate" name="review[rating]" value="1" checked aria-label="No rating." />
                                    <input type="radio" id="first-rate1" name="review[rating]" value="1" />
                                    <label for="first-rate1" title="Terrible">1 star</label>
                                    <input type="radio" id="first-rate2" name="review[rating]" value="2" />
                                    <label for="first-rate2" title="Not good">2 stars</label>
                                    <input type="radio" id="first-rate3" name="review[rating]" value="3" />
                                    <label for="first-rate3" title="Average">3 stars</label>
                                    <input type="radio" id="first-rate4" name="review[rating]" value="4" />
                                    <label for="first-rate4" title="Very good">4 stars</label>
                                    <input type="radio" id="first-rate5" name="review[rating]" value="5" />
                                    <label for="first-rate5" title="Amazing">5 stars</label>
                                </fieldset>
                            </div>
                            <div class="mb-3">
                                <label for="comment" class="calendar-label">Comments</label>
                                <textarea name="review[comment]" id="comment" cols="30" rows="4" class="form-control" required placeholder="Share your experience..." style="resize: vertical; min-height: 100px;"></textarea>
                                <div class="invalid-feedback">Please share your thoughts about your visit.</div>
                            </div>
                            <button class="btn-edit" type="submit" style="width: auto; padding: 0.625rem 1.5rem;">
                                <i class="fa-solid fa-paper-plane"></i>
                                Submit Review
                            </button>
                        </form>
                    </div>
                </div>
            <% } %>
            
            <h5 style="font-size: 1.125rem; font-weight: 600; color: #18181b; margin-bottom: 1.25rem;">All Reviews</h5>
            
            <% if (post.reviews.length === 0) { %>
                <div style="text-align: center; padding: 3rem 1rem; color: #9ca3af;">
                    <i class="fa-regular fa-comment" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                    <p style="font-size: 1rem; font-weight: 500;">No reviews yet. Be the first to review!</p>
                </div>
            <% } else { %>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.25rem;">
                    <% for (let review of post.reviews) { %>
                        <div class="listing-show-card">
                            <div class="listing-show-body">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.875rem;">
                                    <div style="display: flex; align-items: center; gap: 0.625rem;">
                                        <i class="fa-solid fa-user-circle" style="font-size: 2rem; color: #9ca3af;"></i>
                                        <h6 style="margin: 0; font-size: 1rem; font-weight: 600; color: #18181b;">
                                            <%= review.author ? review.author.username : 'Anonymous' %>
                                        </h6>
                                    </div>
                                    <% if (currUser && review.author && currUser._id.equals(review.author._id)) { %>
                                        <form action="/listings/<%= post._id %>/reviews/<%= review._id %>?_method=DELETE" method="post" style="display: inline;">
                                            <button type="submit" class="btn-delete" style="width: auto; padding: 0.5rem; border-radius: 6px; display: inline-flex; align-items: center; justify-content: center;" title="Delete Review">
                                                <i class="fa-solid fa-trash"></i>
                                            </button>
                                        </form>
                                    <% } %>
                                </div>
                                <p style="color: #4b5563; font-size: 0.9375rem; line-height: 1.6; margin-bottom: 0.875rem;">
                                    <%= review.comment %>
                                </p>
                                <div style="display: flex; align-items: center; gap: 0.375rem;">
                                    <% for (let i = 1; i <= 5; i++) { %>
                                        <i class="fa-<%= i <= review.rating ? 'solid' : 'regular' %> fa-star" style="color: #fbbf24; font-size: 0.875rem;"></i>
                                    <% } %>
                                    <span style="margin-left: 0.375rem; padding: 0.25rem 0.5rem; background: #f3f4f6; color: #374151; border-radius: 4px; font-size: 0.8125rem; font-weight: 600;">
                                        <%= review.rating %>/5
                                    </span>
                                </div>
                            </div>
                        </div>
                    <% } %>
                </div>
            <% } %>
        </div>
    </div>
    <!-- Similar Properties Section -->
    <div class="container my-5">
        <h4 class="mb-4 text-center">Similar Properties</h4>
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4">
            <% if (typeof similarListings !=='undefined' && similarListings.length> 0) { %>
                <% similarListings.forEach(function(list) { %>
                    <div class="col">
                        <a href="/listings/<%= list._id %>" class="listing-link">
                            <div class="card h-100 shadow-sm listing-card">
                                <img src="<%= list.image.url %>" class="card-img-top" alt="listing_image"
                                    style="height: 160px; object-fit: cover;">
                                <div class="card-body">
                                    <h6 class="card-title mb-2">
                                        <%= list.title %>
                                    </h6>
                                    <span class="badge bg-secondary mb-2"><i class="fa-solid fa-tag"></i>
                                        <%= list.category %>
                                    </span>
                                    <p class="card-text mb-1">&#8377;
                                        <%= list.price.toLocaleString('en-NP') %>
                                            / night
                                    </p>
                                    <p class="card-text text-muted mb-0" style="font-size:0.95em;">
                                        <%= list.location %>
                                    </p>
                                </div>
                            </div>
                        </a>
                    </div>
                    <% }) %>
                        <% } else { %>
                            <div class="col-12 text-center text-muted">No similar properties found.
                            </div>


                            <% } %>
        </div>
    </div>
    <script src="/js/calendarCart.js"></script>
    <script>
        // Favorite logic using localStorage
        function toggleFavorite(listingId) {
            let favs = JSON.parse(localStorage.getItem('favorites') || '[]');
            if (favs.includes(listingId)) {
                favs = favs.filter(id => id !== listingId);
            } else {
                favs.push(listingId);
            }
            localStorage.setItem('favorites', JSON.stringify(favs));
            document.querySelector('.favorite-btn').classList.toggle('active');
        }
        // Show tax price
        const price = Number("<%= post.price %>");
        const TAX_RATE = 0.13;
        const taxEl = document.querySelector('.tax-amount');
        if (taxEl) {
            const total = price + price * TAX_RATE;
            taxEl.innerHTML =
                `Total after tax: <b>&#8377; ${total.toLocaleString('en-NP', { maximumFractionDigits: 2 })}</b> / night`;
        }
    </script>