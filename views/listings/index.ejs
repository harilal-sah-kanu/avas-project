<% layout('layouts/boilerplate') %>
    <link rel="stylesheet" href="/css/listings.css">

    <!-- Enhanced Filter Section -->
    <div class="container mb-4">
        <div class="card modern-filter-card shadow-lg border-0">
            <div class="card-header filter-header d-flex align-items-center justify-content-between"
                data-bs-toggle="collapse" data-bs-target="#priceFilterCollapse" aria-expanded="false"
                aria-controls="priceFilterCollapse">
                <div class="d-flex align-items-center gap-2">
                    <div class="filter-icon-wrapper">
                        <i class="fa-solid fa-sliders"></i>
                    </div>
                    <div>
                        <h5 class="mb-0 filter-title">Filters & Sorting</h5>
                        <small class="filter-subtitle">Customize your search</small>
                    </div>
                </div>
                <i class="fa-solid fa-chevron-down filter-chevron"></i>
            </div>
            <div class="collapse" id="priceFilterCollapse">
                <form id="priceFilterForm" action="/listings" method="get"
                    class="card-body filter-body row align-items-end g-4">
                    <div class="col-lg-3 col-md-6 col-12">
                        <label for="minPrice" class="form-label filter-label">
                            <i class="fa-solid fa-arrow-down text-success me-2"></i>Minimum Price
                        </label>
                        <div class="input-group input-with-icon">
                            <span class="input-group-text"><i class="fa-solid fa-indian-rupee-sign"></i></span>
                            <input type="number" class="form-control filter-input" id="minPrice" name="minPrice" min="0"
                                placeholder="Min" value="<%= typeof minPrice !== 'undefined' ? minPrice : '' %>">
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 col-12">
                        <label for="maxPrice" class="form-label filter-label">
                            <i class="fa-solid fa-arrow-up text-danger me-2"></i>Maximum Price
                        </label>
                        <div class="input-group input-with-icon">
                            <span class="input-group-text"><i class="fa-solid fa-indian-rupee-sign"></i></span>
                            <input type="number" class="form-control filter-input" id="maxPrice" name="maxPrice" min="0"
                                placeholder="Max" value="<%= typeof maxPrice !== 'undefined' ? maxPrice : '' %>">
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 col-12">
                        <label for="category" class="form-label filter-label">
                            <i class="fa-solid fa-layer-group text-info me-2"></i>Category
                        </label>
                        <select class="form-select filter-select" id="category" name="category">
                            <option value="">All</option>
                            <option value="Trending" <%=category==='Trending' ? 'selected' : '' %>>Trending
                            </option>
                            <option value="Rooms" <%=category==='Rooms' ? 'selected' : '' %>>Rooms</option>
                            <option value="Iconic Cities" <%=category==='Iconic Cities' ? 'selected' : '' %>>Iconic
                                Cities
                            </option>
                            <option value="Mountains" <%=category==='Mountains' ? 'selected' : '' %>>Mountains
                            </option>
                            <option value="Castle" <%=category==='Castle' ? 'selected' : '' %>>Castle</option>
                            <option value="Arctics" <%=category==='Arctics' ? 'selected' : '' %>>Arctics
                            </option>
                            <option value="Camping" <%=category==='Camping' ? 'selected' : '' %>>Camping
                            </option>
                            <option value="Farms" <%=category==='Farms' ? 'selected' : '' %>>Farms</option>
                            <option value="Hotels" <%=category==='Hotels' ? 'selected' : '' %>>Hotels</option>
                            <option value="Beach" <%=category==='Beach' ? 'selected' : '' %>>Beach</option>
                            <option value="Nature" <%=category==='Nature' ? 'selected' : '' %>>Nature</option>
                            <option value="Winter" <%=category==='Winter' ? 'selected' : '' %>>Winter</option>
                            <option value="Lake" <%=category==='Lake' ? 'selected' : '' %>>Lake</option>
                            <option value="Apartment" <%=category==='Apartment' ? 'selected' : '' %>>Apartment
                            </option>
                            <option value="House" <%=category==='House' ? 'selected' : '' %>>House</option>
                            <option value="Breakfast" <%=category==='Breakfast' ? 'selected' : '' %>>Breakfast
                            </option>
                        </select>
                    </div>
                    <div class="col-lg-3 col-md-6 col-12">
                        <label for="sort" class="form-label filter-label">
                            <i class="fa-solid fa-arrow-down-short-wide text-purple me-2"></i>Sort By
                        </label>
                        <select class="form-select filter-select" id="sort" name="sort">
                            <option value="">Default</option>
                            <option value="price-asc" <%=sort==='price-asc' ? 'selected' : '' %>>Price: Low
                                to High
                            </option>
                            <option value="price-desc" <%=sort==='price-desc' ? 'selected' : '' %>>Price:
                                High to Low
                            </option>
                            <option value="newest" <%=sort==='newest' ? 'selected' : '' %>>Newest</option>
                        </select>
                    </div>
                    <div class="col-12 mt-4">
                        <div class="d-flex gap-2 flex-wrap">
                            <button type="submit" class="btn btn-filter-apply flex-grow-1">
                                <i class="fa-solid fa-check-circle me-2"></i>Apply Filters
                            </button>
                            <button type="button" class="btn btn-filter-reset"
                                onclick="window.location.href='/listings'">
                                <i class="fa-solid fa-rotate-right me-2"></i>Reset
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Decorative Welcome Section -->
    <% if (currUser) { %>
        <% } %>
            <div id="filters" class="container-fluid">
                <div class="row align-items-center">
                    <div
                        class="col-12 d-flex flex-wrap justify-content-start justify-content-md-center align-items-center">
                        <div id="filterSliderWrapper">
                            <button id="leftArrow" class="arrow-btn" aria-label="Previous" tabindex="0">
                                <i class="fa-solid fa-chevron-left"></i>
                            </button>
                            <div id="filterSlider">
                                <div class="filter">
                                    <div><i class="fa-solid fa-fire"></i></div>
                                    <p>Trending</p>
                                </div>
                                <div class="filter">
                                    <div><i class="fa-solid fa-bed"></i></div>
                                    <p>Rooms</p>
                                </div>
                                <div class="filter">
                                    <div><i class="fa-solid fa-city"></i></div>
                                    <p>Iconic Cities</p>
                                </div>
                                <div class="filter">
                                    <div><i class="fa-solid fa-mountain-sun"></i></div>
                                    <p>Mountains</p>
                                </div>
                                <div class="filter">
                                    <div><i class="fa-brands fa-fort-awesome"></i></div>
                                    <p>Castle</p>
                                </div>
                                <div class="filter">
                                    <div><i class="fa-solid fa-person-swimming"></i></div>
                                    <p>Arctics</p>
                                </div>
                                <div class="filter">
                                    <div><i class="fa-solid fa-tent"></i></div>
                                    <p>Camping</p>
                                </div>
                                <div class="filter">
                                    <div><i class="fa-solid fa-cow"></i></div>
                                    <p>Farms</p>
                                </div>
                                <div class="filter">
                                    <div><i class="fa-solid fa-hotel"></i></div>
                                    <p>Hotels</p>
                                </div>
                                <div class="filter">
                                    <div><i class="fa-solid fa-umbrella-beach"></i></div>
                                    <p>Beach</p>
                                </div>
                                <div class="filter">
                                    <div><i class="fa-solid fa-tree"></i></div>
                                    <p>Nature</p>
                                </div>
                                <div class="filter">
                                    <div><i class="fa-solid fa-snowflake"></i></div>
                                    <p>Winter</p>
                                </div>
                                <div class="filter">
                                    <div><i class="fa-solid fa-water"></i></div>
                                    <p>Lake</p>
                                </div>
                                <div class="filter">
                                    <div><i class="fa-solid fa-building"></i></div>
                                    <p>Apartment</p>
                                </div>
                                <div class="filter">
                                    <div><i class="fa-solid fa-house"></i></div>
                                    <p>House</p>
                                </div>
                                <div class="filter">
                                    <div><i class="fa-solid fa-mug-hot"></i></div>
                                    <p>Breakfast</p>
                                </div>
                                <!-- Add more icons as needed -->
                            </div>
                            <button id="rightArrow" class="arrow-btn" aria-label="Next" tabindex="0">
                                <i class="fa-solid fa-chevron-right"></i>
                            </button>
                        </div>
                        <div class="tax-toggle ms-auto">
                            <div class="form-check-reverse form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="switchCheckDefault">
                                <label class="form-check-label" for="switchCheckDefault">Display total after
                                    taxes</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>



            <!-- Main Listings Section -->
            <div class="row row-cols-lg-3 row-cols-md-2 row-cols-1 g-4 mt-3">
                <% if (allListing.length===0) { %>
                    <div class="col-12 d-flex flex-column align-items-center justify-content-center w-100"
                        style="min-height:60vh;">
                        <div class="d-flex flex-column align-items-center justify-content-center w-100 h-100">
                            <i
                                class="fa-solid fa-circle-exclamation fa-3x mb-3 text-warning animate__animated animate__bounceIn"></i>
                            <span class="fs-4 fw-semibold text-center mb-2">No listings found
                                for your selected
                                filters.</span>
                            <span class="text-muted text-center mb-3">Try adjusting your search
                                criteria or filters to
                                see
                                more results.</span>
                            <button class="btn btn-outline-success px-4 py-2 mt-2"
                                onclick="window.location.href='/listings'">
                                <i class="fa-solid fa-rotate-left me-1"></i> Reset Filters
                            </button>
                        </div>
                    </div>
                    <% } else { %>
                        <% for (list of allListing) { %>
                            <div class="col">
                                <%- include('_listingCard', { list: list }) %>
                            </div>


                            <% } %>

                                <% } %>
            </div>

            <!-- Pagination Controls -->
            <% if (totalPages> 1) { %>
                <div class="container mt-5 mb-4">
                    <nav aria-label="Listings pagination">
                        <ul class="pagination pagination-lg justify-content-center flex-wrap">
                            <!-- Previous Button -->
                            <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
                                <a class="page-link"
                                    href="?page=<%= currentPage - 1 %><%= category ? '&category=' + category : '' %><%= minPrice ? '&minPrice=' + minPrice : '' %><%= maxPrice ? '&maxPrice=' + maxPrice : '' %><%= sort ? '&sort=' + sort : '' %>"
                                    aria-label="Previous">
                                    <span aria-hidden="true">&laquo; Previous</span>
                                </a>
                            </li>

                            <!-- Page Numbers -->
                            <% let startPage=Math.max(1, currentPage - 2); let endPage=Math.min(totalPages, currentPage
                                + 2); if (startPage> 1) { %>
                                <li class="page-item">
                                    <a class="page-link"
                                        href="?page=1<%= category ? '&category=' + category : '' %><%= minPrice ? '&minPrice=' + minPrice : '' %><%= maxPrice ? '&maxPrice=' + maxPrice : '' %><%= sort ? '&sort=' + sort : '' %>">1</a>
                                </li>
                                <% if (startPage> 2) { %>
                                    <li class="page-item disabled"><span class="page-link">...</span></li>
                                    <% } %>
                                        <% } %>

                                            <% for (let i=startPage; i <=endPage; i++) { %>
                                                <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                                                    <a class="page-link"
                                                        href="?page=<%= i %><%= category ? '&category=' + category : '' %><%= minPrice ? '&minPrice=' + minPrice : '' %><%= maxPrice ? '&maxPrice=' + maxPrice : '' %><%= sort ? '&sort=' + sort : '' %>">
                                                        <%= i %>
                                                    </a>
                                                </li>
                                                <% } %>

                                                    <% if (endPage < totalPages) { %>
                                                        <% if (endPage < totalPages - 1) { %>
                                                            <li class="page-item disabled"><span
                                                                    class="page-link">...</span></li>
                                                            <% } %>
                                                                <li class="page-item">
                                                                    <a class="page-link"
                                                                        href="?page=<%= totalPages %><%= category ? '&category=' + category : '' %><%= minPrice ? '&minPrice=' + minPrice : '' %><%= maxPrice ? '&maxPrice=' + maxPrice : '' %><%= sort ? '&sort=' + sort : '' %>">
                                                                        <%= totalPages %>
                                                                    </a>
                                                                </li>
                                                                <% } %>

                                                                    <!-- Next Button -->
                                                                    <li
                                                                        class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
                                                                        <a class="page-link"
                                                                            href="?page=<%= currentPage + 1 %><%= category ? '&category=' + category : '' %><%= minPrice ? '&minPrice=' + minPrice : '' %><%= maxPrice ? '&maxPrice=' + maxPrice : '' %><%= sort ? '&sort=' + sort : '' %>"
                                                                            aria-label="Next">
                                                                            <span aria-hidden="true">Next &raquo;</span>
                                                                        </a>
                                                                    </li>
                        </ul>
                        <p class="text-center text-muted mt-2">
                            Page <%= currentPage %> of <%= totalPages %> (Total: <%= totalListings %> properties)
                        </p>
                    </nav>
                </div>
                <% } %>

                    <form id="categoryFilterForm" action="/listings" method="get" style="display:none;">
                        <input type="hidden" name="category" id="categorySelect" value="">
                    </form>

                    <script src="/js/listingPage.js"></script>
                    <script src="/js/pagination.js"></script>