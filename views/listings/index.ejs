<% layout('layouts/boilerplate') %>
<link rel="stylesheet" href="/css/listings.css">

<!-- Filters Section - Fixed at top -->
<div class="filters-wrapper">
    <div class="container-fluid">
        <div class="filters-bar">
            <!-- Page Title -->
            <div class="page-title-section">
                <h1 class="page-title">Explore Properties</h1>
                <p class="page-subtitle"><%= allListing.length %> properties available</p>
            </div>
            
            <!-- Filter Button -->
            <div class="filter-controls">
                <button class="filter-btn" data-bs-toggle="modal" data-bs-target="#filterModal">
                    <i class="fa-solid fa-sliders"></i>
                    <span>Filters</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Filter Modal - Mac Style Full Screen -->
<div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="filterModalLabel">Filters</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="/listings" method="get">
                <div class="modal-body">
                    <div class="filter-form-container">
                        <!-- Left Column -->
                        <div class="filter-column">
                            <!-- Price Range -->
                            <div class="filter-group">
                                <label class="filter-label">Price Range</label>
                                <div class="price-inputs">
                                    <div class="price-input-group">
                                        <label>Minimum</label>
                                        <div class="input-wrapper">
                                            <span class="currency">₹</span>
                                            <input type="number" name="minPrice" placeholder="0" value="<%= typeof minPrice !== 'undefined' ? minPrice : '' %>">
                                        </div>
                                    </div>
                                    <div class="price-separator">—</div>
                                    <div class="price-input-group">
                                        <label>Maximum</label>
                                        <div class="input-wrapper">
                                            <span class="currency">₹</span>
                                            <input type="number" name="maxPrice" placeholder="10000+" value="<%= typeof maxPrice !== 'undefined' ? maxPrice : '' %>">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Sort By -->
                            <div class="filter-group">
                                <label class="filter-label">Sort by</label>
                                <select name="sort" class="filter-select">
                                    <option value="">Recommended</option>
                                    <option value="price-asc" <%= sort === 'price-asc' ? 'selected' : '' %>>Price: Low to High</option>
                                    <option value="price-desc" <%= sort === 'price-desc' ? 'selected' : '' %>>Price: High to Low</option>
                                    <option value="newest" <%= sort === 'newest' ? 'selected' : '' %>>Newest First</option>
                                </select>
                            </div>

                            <!-- Show Total Tax Toggle -->
                            <div class="filter-group">
                                <label class="filter-label">Display</label>
                                <div class="tax-toggle-wrapper">
                                    <label class="tax-toggle-label">
                                        <input type="checkbox" id="switchCheckDefault" class="tax-checkbox">
                                        <span class="tax-toggle-slider"></span>
                                        <span class="tax-toggle-text">Show total price with taxes</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Right Column -->
                        <div class="filter-column">
                            <!-- Category Selection with Icons -->
                            <div class="filter-group">
                                <label class="filter-label">Property Type</label>
                                <input type="hidden" name="category" id="categoryInput" value="<%= typeof category !== 'undefined' ? category : '' %>">
                                <div class="category-grid">
                                    <div class="category-option <%= category === 'Trending' ? 'selected' : '' %>" data-category="Trending">
                                        <i class="fa-solid fa-fire"></i>
                                        <span>Trending</span>
                                    </div>
                                    <div class="category-option <%= category === 'Rooms' ? 'selected' : '' %>" data-category="Rooms">
                                        <i class="fa-solid fa-bed"></i>
                                        <span>Rooms</span>
                                    </div>
                                    <div class="category-option <%= category === 'Iconic Cities' ? 'selected' : '' %>" data-category="Iconic Cities">
                                        <i class="fa-solid fa-city"></i>
                                        <span>Cities</span>
                                    </div>
                                    <div class="category-option <%= category === 'Mountains' ? 'selected' : '' %>" data-category="Mountains">
                                        <i class="fa-solid fa-mountain-sun"></i>
                                        <span>Mountains</span>
                                    </div>
                                    <div class="category-option <%= category === 'Castle' ? 'selected' : '' %>" data-category="Castle">
                                        <i class="fa-brands fa-fort-awesome"></i>
                                        <span>Castle</span>
                                    </div>
                                    <div class="category-option <%= category === 'Beach' ? 'selected' : '' %>" data-category="Beach">
                                        <i class="fa-solid fa-umbrella-beach"></i>
                                        <span>Beach</span>
                                    </div>
                                    <div class="category-option <%= category === 'Camping' ? 'selected' : '' %>" data-category="Camping">
                                        <i class="fa-solid fa-tent"></i>
                                        <span>Camping</span>
                                    </div>
                                    <div class="category-option <%= category === 'Farms' ? 'selected' : '' %>" data-category="Farms">
                                        <i class="fa-solid fa-cow"></i>
                                        <span>Farms</span>
                                    </div>
                                    <div class="category-option <%= category === 'Nature' ? 'selected' : '' %>" data-category="Nature">
                                        <i class="fa-solid fa-tree"></i>
                                        <span>Nature</span>
                                    </div>
                                    <div class="category-option <%= category === 'Lake' ? 'selected' : '' %>" data-category="Lake">
                                        <i class="fa-solid fa-water"></i>
                                        <span>Lake</span>
                                    </div>
                                    <div class="category-option <%= category === 'Winter' ? 'selected' : '' %>" data-category="Winter">
                                        <i class="fa-solid fa-snowflake"></i>
                                        <span>Winter</span>
                                    </div>
                                    <div class="category-option <%= category === 'House' ? 'selected' : '' %>" data-category="House">
                                        <i class="fa-solid fa-house"></i>
                                        <span>House</span>
                                    </div>
                                    <div class="category-option <%= category === 'Apartment' ? 'selected' : '' %>" data-category="Apartment">
                                        <i class="fa-solid fa-building"></i>
                                        <span>Apartment</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-clear" onclick="window.location.href='/listings'">Clear all</button>
                    <button type="submit" class="btn-apply">Show results</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="container main-content">
    <div class="listings-grid">
        <% if (allListing.length === 0) { %>
            <div class="empty-state">
                <i class="fa-regular fa-circle-xmark"></i>
                <h3>No listings found</h3>
                <p>Try adjusting your search criteria or filters to see more results.</p>
                <button class="btn-reset" onclick="window.location.href='/listings'">
                    <i class="fa-solid fa-rotate-right"></i>
                    Reset Filters
                </button>
            </div>
        <% } else { %>
            <% for (let list of allListing) { %>
                <%- include('_listingCard', { list: list }) %>
            <% } %>
        <% } %>
    </div>
    
    <!-- Pagination -->
    <% if (totalPages > 1) { %>
        <nav class="pagination-nav" aria-label="Listings pagination">
            <ul class="pagination">
                <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
                    <a class="page-link" href="?page=<%= currentPage - 1 %><%= category ? '&category=' + category : '' %><%= minPrice ? '&minPrice=' + minPrice : '' %><%= maxPrice ? '&maxPrice=' + maxPrice : '' %><%= sort ? '&sort=' + sort : '' %>">
                        <i class="fa-solid fa-chevron-left"></i>
                    </a>
                </li>
                
                <% for (let i = 1; i <= totalPages; i++) { %>
                    <% if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) { %>
                        <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                            <a class="page-link" href="?page=<%= i %><%= category ? '&category=' + category : '' %><%= minPrice ? '&minPrice=' + minPrice : '' %><%= maxPrice ? '&maxPrice=' + maxPrice : '' %><%= sort ? '&sort=' + sort : '' %>">
                                <%= i %>
                            </a>
                        </li>
                    <% } else if (i === currentPage - 2 || i === currentPage + 2) { %>
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    <% } %>
                <% } %>
                
                <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
                    <a class="page-link" href="?page=<%= currentPage + 1 %><%= category ? '&category=' + category : '' %><%= minPrice ? '&minPrice=' + minPrice : '' %><%= maxPrice ? '&maxPrice=' + maxPrice : '' %><%= sort ? '&sort=' + sort : '' %>">
                        <i class="fa-solid fa-chevron-right"></i>
                    </a>
                </li>
            </ul>
        </nav>
    <% } %>
</div>

<script src="/js/listingPage.js"></script>
<script src="/js/pagination.js"></script>